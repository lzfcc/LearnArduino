# Hop 播放（串口通信 + LZO 压缩）

## 步骤

视频预处理和[Bad Apple](../apple)类似。

用 image2lcd（Windows）将图片转为 256 色。16 位色彩每帧太大，传输有困难，而且一些帧无法压缩。

串口通信程序按顺序读取 LZO 压缩过的二进制文件发送到串口即可。

Arduino 程序中，按照提前计算好的每帧压缩后字节数进行分割、解压缩和绘制，调用`color8to16`将 8 位色彩转成 16 位色彩，然后调用 `drawPixel`方法直接绘制像素。

也尝试了脱机播放，比用串口通信流畅，但是因为空间有限，无法将整个视频写入闪存。

## 存在的问题

- 无法使用更高的波特率通信，没有查到相关说明，不明白 M5StickC 所谓的支持的更高的波特率是什么意思。还是只能用 115200。
- 因为每一帧的压缩率不同，所以可能不是匀速播放的。

## 采坑

- 尝试 16 位色彩，发现每帧太大，而且有的帧无法压缩。因为 LZO 算法是基于数据中的局部重复性来压缩（？），色彩深度大，以及视频本身的特性，可能导致图像的随机性很大，所以没有压缩余地。
- 通信 python 程序的波特率写错，导致输出图像一直是花屏。
- 刚开始 8 位转 16 位色彩是自己写的。从 332 转到 565，直接乘以了一个倍数，颜色失真很严重。后来才查到有现成的转换函数。还是一个日文[文档]（https://lang-ship.com/reference/M5StickC/0.0.5/class_t_f_t__e_s_p_i.html），好在基本可以看懂。GitHub 的官方文档都没有这个全……
- 其实除了色彩深度增加，本质上和 bad apple 没有什么差别，但还是费了几天的功夫。